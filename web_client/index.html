<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bloch Sphere Visualizer (Web)</title>
  <script src="https://cdn.plot.ly/plotly-2.35.3.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    #plot { width: 100%; height: 80vh; }
    input, select { font-size: 14px; padding: 6px 8px; }
  </style>
</head>
<body>
  <h2>Bloch Sphere Visualizer (Web)</h2>
  <div>
    <label>Gate sequence</label>
    <input id="sequence" style="width: 60%" value="H, Rz(pi/2), H" />
    <button id="run">Run</button>
  </div>
  <div id="plot"></div>

  <script>
    async function fetchPath(sequence) {
      const res = await fetch('/bloch-path', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sequence })
      });
      const json = await res.json();
      return json.path || [];
    }

    function renderPlot(path) {
      // Base sphere
      const u = [], v = [];
      const uSteps = 60, vSteps = 30;
      for (let i = 0; i < uSteps; i++) u.push(2 * Math.PI * i / (uSteps - 1));
      for (let j = 0; j < vSteps; j++) v.push(Math.PI * j / (vSteps - 1));

      const xs = [], ys = [], zs = [];
      for (let i = 0; i < u.length; i++) {
        xs[i] = []; ys[i] = []; zs[i] = [];
        for (let j = 0; j < v.length; j++) {
          xs[i][j] = Math.cos(u[i]) * Math.sin(v[j]);
          ys[i][j] = Math.sin(u[i]) * Math.sin(v[j]);
          zs[i][j] = Math.cos(v[j]);
        }
      }

      const sphere = {
        type: 'surface', x: xs, y: ys, z: zs, showscale: false, opacity: 0.28,
        colorscale: [[0, '#e6f0ff'], [1, '#99c2ff']]
      };

      const axes = [
        {type:'scatter3d', x:[-1,1], y:[0,0], z:[0,0], mode:'lines', line:{color:'#bbb'}},
        {type:'scatter3d', x:[0,0], y:[-1,1], z:[0,0], mode:'lines', line:{color:'#bbb'}},
        {type:'scatter3d', x:[0,0], y:[0,0], z:[-1,1], mode:'lines', line:{color:'#bbb'}},
      ];

      const traces = [sphere, ...axes];
      if (path.length) {
        const xsP = path.map(p => p[0]);
        const ysP = path.map(p => p[1]);
        const zsP = path.map(p => p[2]);
        traces.push({type:'scatter3d', x: xsP, y: ysP, z: zsP, mode: 'lines+markers', line:{color:'#d62728', width:6}, marker:{size:3, color:'#d62728'}});
        traces.push({type:'scatter3d', x: [xsP[xsP.length-1]], y: [ysP[ysP.length-1]], z: [zsP[zsP.length-1]], mode: 'markers', marker:{size:7, color:'#111'}});
      }

      Plotly.newPlot('plot', traces, {
        scene: {
          aspectmode: 'cube',
          xaxis: {range: [-1.1,1.1], title:'X', gridcolor:'#eee'},
          yaxis: {range: [-1.1,1.1], title:'Y', gridcolor:'#eee'},
          zaxis: {range: [-1.1,1.1], title:'Z', gridcolor:'#eee'}
        },
        margin: {l:0, r:0, b:0, t:30},
        title: 'Bloch Sphere (Web)'
      });
    }

    document.getElementById('run').addEventListener('click', async () => {
      const raw = document.getElementById('sequence').value;
      const seq = raw.split(',').map(s => s.trim()).filter(Boolean);
      const path = await fetchPath(seq);
      renderPlot(path);
    });

    // Initial render
    document.getElementById('run').click();
  </script>
</body>
</html>
